<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAP - Sistem Absensi Pesantren</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google API Scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }

        /* Toggle Transition */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ec4899;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ec4899;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-hidden h-screen flex">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-emerald-50 z-50 flex items-center justify-center flex-col transition-opacity duration-500">
        <div class="animate-spin mb-4 w-10 h-10 border-4 border-emerald-600 border-t-transparent rounded-full"></div>
        <p id="loading-text" class="text-emerald-800 font-semibold text-lg">Memuat Sistem Pesantren...</p>
    </div>

    <!-- App Container (Hidden initially) -->
    <div id="app-container" class="hidden flex-1 flex h-full w-full">
        
        <!-- Sidebar (Desktop) -->
        <aside class="w-64 bg-emerald-900 text-white flex-shrink-0 hidden md:flex flex-col shadow-xl z-10 transition-colors duration-300" id="sidebar-bg">
            <div class="p-6 border-b border-white/10 flex flex-col gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg text-white">
                        <i data-lucide="moon" class="w-6 h-6"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h1 id="sidebar-title" class="font-bold text-lg leading-tight truncate">SIAP</h1>
                        <p id="sidebar-subtitle" class="text-xs text-emerald-200/80 truncate">Sistem Absensi Pesantren</p>
                    </div>
                </div>
                
                <!-- Toggle Gender Desktop -->
                <div id="gender-toggle-desktop" class="w-full"></div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="navigateTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-white/70 hover:bg-white/10 hover:text-white" data-tab="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="navigateTo('santri')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-white/70 hover:bg-white/10 hover:text-white" data-tab="santri">
                    <i data-lucide="users" class="w-5 h-5"></i> <span class="font-medium">Data Santri</span>
                </button>
                <button onclick="navigateTo('absensi')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-white/70 hover:bg-white/10 hover:text-white" data-tab="absensi">
                    <i data-lucide="calendar-check" class="w-5 h-5"></i> <span class="font-medium">Input Absensi</span>
                </button>
                <button onclick="navigateTo('laporan')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-white/70 hover:bg-white/10 hover:text-white" data-tab="laporan">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i> <span class="font-medium">Laporan</span>
                </button>
                
                <div class="pt-4 mt-4 border-t border-white/10">
                    <button onclick="navigateTo('profil')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-white/70 hover:bg-white/10 hover:text-white" data-tab="profil">
                        <i data-lucide="settings" class="w-5 h-5"></i> <span class="font-medium">Profil Pondok</span>
                    </button>
                </div>
            </nav>
            
            <div class="p-4 border-t border-white/10 text-xs text-white/50 text-center">
                <div id="connection-status" class="mb-2 px-2 py-1 rounded bg-black/20 text-white flex items-center justify-center gap-1">
                    <div class="w-2 h-2 rounded-full bg-green-400"></div> Online
                </div>
                &copy; 2024 <span id="footer-school-name">Pondok Pesantren</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto bg-gray-50 relative w-full flex flex-col">
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm p-4 sticky top-0 z-20 md:hidden flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-600 p-1.5 rounded text-white" id="mobile-logo-bg">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </div>
                    <h1 id="mobile-title" class="font-bold text-gray-800 truncate">SIAP Pesantren</h1>
                </div>
                <!-- Toggle Gender Mobile -->
                <div id="gender-toggle-mobile"></div>
            </header>

            <!-- Content Container -->
            <div id="content-area" class="p-4 md:p-8 pb-24 md:pb-8 max-w-6xl mx-auto w-full fade-in">
                <!-- Content injected via JS -->
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 z-50 shadow-lg hidden">
        <button onclick="navigateTo('dashboard')" class="mobile-nav-item flex flex-col items-center justify-center w-full py-1 text-gray-400" data-tab="dashboard">
            <div class="mb-1 icon-container"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></div>
            <span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="navigateTo('absensi')" class="mobile-nav-item flex flex-col items-center justify-center w-full py-1 text-gray-400" data-tab="absensi">
            <div class="mb-1 icon-container"><i data-lucide="calendar-check" class="w-5 h-5"></i></div>
            <span class="text-[10px] font-medium">Absen</span>
        </button>
        <button onclick="navigateTo('laporan')" class="mobile-nav-item flex flex-col items-center justify-center w-full py-1 text-gray-400" data-tab="laporan">
            <div class="mb-1 icon-container"><i data-lucide="clipboard-list" class="w-5 h-5"></i></div>
            <span class="text-[10px] font-medium">Lapor</span>
        </button>
        <button onclick="navigateTo('profil')" class="mobile-nav-item flex flex-col items-center justify-center w-full py-1 text-gray-400" data-tab="profil">
            <div class="mb-1 icon-container"><i data-lucide="settings" class="w-5 h-5"></i></div>
            <span class="text-[10px] font-medium">Akun</span>
        </button>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let state = {
            user: null,
            activeTab: 'dashboard',
            santriList: [],
            attendanceRecords: [],
            schoolProfile: null,
            newSantri: { nama: '', kelas: '', kamar: '', gender: 'L' },
            absensiForm: {
                date: new Date().toISOString().split('T')[0],
                activity: 'Subuh Berjamaah',
                data: {},
                isSaved: false,
                loadedId: null 
            },
            laporanDate: new Date().toISOString().split('T')[0],
            profileForm: { namaPondok: '', pengasuh: '', alamat: '', kontak: '' },
            isOffline: false,
            appId: 'default-app-id',
            genderFilter: 'L', // 'L' for Putra, 'P' for Putri
            
            // Google Drive State
            gDrive: {
                connected: false,
                tokenClient: null,
                accessToken: null,
                config: { 
                    clientId: '133835424632-crnnjf5mhr3g2bl4fsqvh13hld6h92gc.apps.googleusercontent.com', 
                    apiKey: 'AIzaSyDySWvaM7P-P3-kmDGNnUCt2TmZQ1XKg8A' 
                }
            }
        };

        const activities = [
            'Subuh Berjamaah', 'Dhuha & Ngaji Pagi', 'Sekolah Formal', 
            'Ashar Berjamaah', 'Ngaji Sore', 'Maghrib Berjamaah', 
            'Isya & Taklim', 'Tahajud'
        ];

        // --- GOOGLE DRIVE ADAPTER (Same as before) ---
        const GDriveAdapter = {
            init: () => {
                const configStr = localStorage.getItem('gdrive_config');
                if (configStr) {
                    const localCfg = JSON.parse(configStr);
                    if(localCfg.clientId) state.gDrive.config = localCfg;
                }
                if(state.gDrive.config.clientId && state.gDrive.config.apiKey) {
                    GDriveAdapter.loadGapi();
                }
            },
            loadGapi: () => {
                if (typeof gapi === 'undefined') return;
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: state.gDrive.config.apiKey,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        });
                        state.gDrive.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: state.gDrive.config.clientId,
                            scope: 'https://www.googleapis.com/auth/drive.file',
                            callback: (tokenResponse) => {
                                state.gDrive.accessToken = tokenResponse.access_token;
                                state.gDrive.connected = true;
                                renderApp(); 
                                alert("Login Google Berhasil! Fitur Backup Aktif.");
                            },
                        });
                    } catch(err) { console.error("GAPI Init Error", err); }
                });
            },
            login: () => {
                if(state.gDrive.tokenClient) {
                    state.gDrive.tokenClient.requestAccessToken();
                } else {
                    alert("Sedang memuat layanan Google... Coba refresh halaman.");
                }
            },
            saveToDrive: async () => {
                if (!state.gDrive.accessToken) return alert("Silakan Login Google Terlebih Dahulu");
                const dataToSave = {
                    santriList: state.santriList,
                    attendanceRecords: state.attendanceRecords,
                    schoolProfile: state.schoolProfile,
                    backupDate: new Date().toISOString()
                };
                const fileContent = JSON.stringify(dataToSave);
                const fileMetadata = { 'name': 'siap_pesantren_backup.json', 'mimeType': 'application/json' };
                try {
                    const q = "name = 'siap_pesantren_backup.json' and trashed = false";
                    const response = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                    const files = response.result.files;
                    if (files && files.length > 0) {
                        const fileId = files[0].id;
                        await gapi.client.request({
                            path: '/upload/drive/v3/files/' + fileId,
                            method: 'PATCH',
                            params: { uploadType: 'media' },
                            body: fileContent
                        });
                        alert("Backup Berhasil Diperbarui di Google Drive!");
                    } else {
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                        form.append('file', new Blob([fileContent], { type: 'application/json' }));
                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: new Headers({ 'Authorization': 'Bearer ' + state.gDrive.accessToken }),
                            body: form
                        });
                        alert("Backup Baru Berhasil Dibuat di Google Drive!");
                    }
                } catch (err) { alert("Gagal upload: " + err.message); }
            },
            loadFromDrive: async () => {
                 if (!state.gDrive.accessToken) return alert("Silakan Login Google Terlebih Dahulu");
                 try {
                    const q = "name = 'siap_pesantren_backup.json' and trashed = false";
                    const response = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                    const files = response.result.files;
                    if (files && files.length > 0) {
                        const fileId = files[0].id;
                        const fileRes = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                        const data = fileRes.result;
                        if(data && confirm(`Ditemukan backup tanggal ${new Date(data.backupDate).toLocaleString()}. Pulihkan data?`)) {
                             if(data.santriList) {
                                state.santriList = data.santriList;
                                if(state.isOffline) localStorage.setItem('siap_santri', JSON.stringify(data.santriList));
                             }
                             if(data.attendanceRecords) {
                                state.attendanceRecords = data.attendanceRecords;
                                if(state.isOffline) localStorage.setItem('siap_absensi', JSON.stringify(data.attendanceRecords));
                             }
                             if(data.schoolProfile) {
                                state.schoolProfile = data.schoolProfile;
                                if(state.isOffline) localStorage.setItem('siap_profile', JSON.stringify(data.schoolProfile));
                             }
                             alert("Data berhasil dipulihkan!");
                             renderApp();
                        }
                    } else { alert("Tidak ditemukan file backup di Drive Anda."); }
                 } catch (err) { alert("Gagal mengambil data: " + err.message); }
            }
        };

        // --- DATA ADAPTER (Hybrid) ---
        const DataAdapter = {
            init: async () => {
                GDriveAdapter.init(); 
                const userConfigStr = localStorage.getItem('user_firebase_config');
                let configToUse = null;
                if (userConfigStr) { try { configToUse = JSON.parse(userConfigStr); } catch (e) {} } 
                if (!configToUse && typeof __firebase_config !== 'undefined') {
                    try { configToUse = JSON.parse(__firebase_config); } catch (e) {
                        if(typeof __firebase_config === 'object') configToUse = __firebase_config;
                    }
                }
                if (configToUse && Object.keys(configToUse).length > 0) {
                    try {
                        const app = initializeApp(configToUse);
                        state.auth = getAuth(app);
                        state.db = getFirestore(app);
                        state.isOffline = false;
                        updateConnectionStatus(true);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(state.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(state.auth);
                        }
                        onAuthStateChanged(state.auth, (user) => {
                            if (user) {
                                state.user = user;
                                DataAdapter.startListeners();
                            }
                        });
                    } catch (e) { console.error("Firebase fail", e); DataAdapter.goOffline(); }
                } else { DataAdapter.goOffline(); }
            },
            goOffline: () => {
                state.isOffline = true;
                state.user = { uid: 'offline-user' };
                updateConnectionStatus(false);
                setTimeout(() => { DataAdapter.startListeners(); }, 500);
            },
            startListeners: () => {
                if (state.isOffline) {
                    const loadLocal = () => {
                        const santriRaw = localStorage.getItem('siap_santri') || '[]';
                        const absensiRaw = localStorage.getItem('siap_absensi') || '[]';
                        const profileRaw = localStorage.getItem('siap_profile');
                        state.santriList = JSON.parse(santriRaw).sort((a, b) => a.nama.localeCompare(b.nama));
                        state.attendanceRecords = JSON.parse(absensiRaw);
                        if(profileRaw) state.schoolProfile = JSON.parse(profileRaw);
                        finishLoading();
                    };
                    loadLocal();
                    window.addEventListener('storage', loadLocal);
                } else {
                    const uid = state.user.uid;
                    const appId = state.appId;
                    onSnapshot(collection(state.db, 'artifacts', appId, 'users', uid, 'santri'), (snap) => {
                        const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        state.santriList = data.sort((a, b) => a.nama.localeCompare(b.nama));
                        finishLoading();
                    });
                    onSnapshot(collection(state.db, 'artifacts', appId, 'users', uid, 'absensi'), (snap) => {
                        state.attendanceRecords = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (state.activeTab !== 'absensi') { renderApp(); }
                    });
                    onSnapshot(doc(state.db, 'artifacts', appId, 'users', uid, 'settings', 'profile'), (snap) => {
                        if (snap.exists()) {
                            state.schoolProfile = snap.data();
                            state.profileForm = { ...snap.data() };
                            updateGlobalUI();
                        }
                        finishLoading();
                    });
                }
            },
            saveSantri: async (data) => {
                if (state.isOffline) {
                    const newId = 's_' + Date.now();
                    const newEntry = { id: newId, ...data, createdAt: new Date().toISOString() };
                    const list = JSON.parse(localStorage.getItem('siap_santri') || '[]');
                    list.push(newEntry);
                    localStorage.setItem('siap_santri', JSON.stringify(list));
                    DataAdapter.startListeners(); 
                } else {
                    await setDoc(doc(collection(state.db, 'artifacts', state.appId, 'users', state.user.uid, 'santri')), {
                        ...data, createdAt: serverTimestamp()
                    });
                }
            },
            deleteSantri: async (id) => {
                if (state.isOffline) {
                    let list = JSON.parse(localStorage.getItem('siap_santri') || '[]');
                    list = list.filter(s => s.id !== id);
                    localStorage.setItem('siap_santri', JSON.stringify(list));
                    DataAdapter.startListeners();
                } else {
                    await deleteDoc(doc(state.db, 'artifacts', state.appId, 'users', state.user.uid, 'santri', id));
                }
            },
            saveAbsensi: async (id, data) => {
                if (state.isOffline) {
                    let list = JSON.parse(localStorage.getItem('siap_absensi') || '[]');
                    const idx = list.findIndex(r => r.id === id);
                    const record = { id, ...data, updatedAt: new Date().toISOString() };
                    if (idx >= 0) list[idx] = record;
                    else list.push(record);
                    localStorage.setItem('siap_absensi', JSON.stringify(list));
                    const existingIdx = state.attendanceRecords.findIndex(r => r.id === id);
                    if(existingIdx >= 0) state.attendanceRecords[existingIdx] = record;
                    else state.attendanceRecords.push(record);
                } else {
                    await setDoc(doc(state.db, 'artifacts', state.appId, 'users', state.user.uid, 'absensi', id), {
                        ...data, updatedAt: serverTimestamp()
                    });
                }
            },
            saveProfile: async (data) => {
                if (state.isOffline) {
                    localStorage.setItem('siap_profile', JSON.stringify(data));
                    state.schoolProfile = data;
                    updateGlobalUI();
                    DataAdapter.startListeners();
                } else {
                    await setDoc(doc(state.db, 'artifacts', state.appId, 'users', state.user.uid, 'settings', 'profile'), {
                        ...data, updatedAt: serverTimestamp()
                    });
                }
            }
        };

        // --- HELPER FUNCTIONS ---
        function updateConnectionStatus(isOnline) {
            const el = document.getElementById('connection-status');
            if (!el) return;
            if (isOnline) {
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-400"></div> Cloud Online';
                el.className = "mb-2 px-2 py-1 rounded bg-black/20 text-white flex items-center justify-center gap-1 text-xs";
            } else {
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-yellow-400"></div> Mode Lokal';
                el.className = "mb-2 px-2 py-1 rounded bg-black/20 text-white flex items-center justify-center gap-1 text-xs";
            }
        }

        function finishLoading() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('mobile-nav').classList.remove('hidden');
            renderApp();
        }

        // --- GENDER TOGGLE LOGIC ---
        window.toggleGender = () => {
            state.genderFilter = state.genderFilter === 'L' ? 'P' : 'L';
            renderApp();
        }

        function renderGenderToggle() {
            const isPutri = state.genderFilter === 'P';
            const bgColor = isPutri ? 'bg-pink-600' : 'bg-blue-600';
            const icon = isPutri ? '<i data-lucide="user" class="w-4 h-4"></i>' : '<i data-lucide="user" class="w-4 h-4"></i>';
            const text = isPutri ? 'Putri' : 'Putra';
            
            // Render Desktop Toggle
            const desktopContainer = document.getElementById('gender-toggle-desktop');
            if (desktopContainer) {
                desktopContainer.innerHTML = `
                    <button onclick="toggleGender()" class="relative w-full h-10 bg-black/20 rounded-lg flex items-center justify-between px-1 cursor-pointer transition-all duration-300 shadow-inner group">
                        <div class="absolute top-1 bottom-1 w-[calc(50%-4px)] ${isPutri ? 'left-[calc(50%+2px)] bg-pink-500' : 'left-1 bg-blue-500'} rounded-md transition-all duration-300 shadow-md"></div>
                        <div class="z-10 w-1/2 text-center text-xs font-bold ${!isPutri ? 'text-white' : 'text-white/50'} flex items-center justify-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> Putra</div>
                        <div class="z-10 w-1/2 text-center text-xs font-bold ${isPutri ? 'text-white' : 'text-white/50'} flex items-center justify-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> Putri</div>
                    </button>
                `;
            }

            // Render Mobile Toggle
            const mobileContainer = document.getElementById('gender-toggle-mobile');
            if (mobileContainer) {
                mobileContainer.innerHTML = `
                    <button onclick="toggleGender()" class="relative w-24 h-8 bg-gray-200 rounded-full flex items-center justify-between px-1 cursor-pointer shadow-inner">
                        <div class="absolute top-1 bottom-1 w-[calc(50%-4px)] ${isPutri ? 'translate-x-full bg-pink-500' : 'translate-x-0 bg-blue-500'} rounded-full transition-all duration-300 shadow-sm"></div>
                        <div class="z-10 w-1/2 text-center flex justify-center ${!isPutri ? 'text-white' : 'text-gray-400'}"><i data-lucide="user" class="w-4 h-4"></i></div>
                        <div class="z-10 w-1/2 text-center flex justify-center ${isPutri ? 'text-white' : 'text-gray-400'}"><i data-lucide="user" class="w-4 h-4"></i></div>
                    </button>
                `;
            }
            
            // Update Theme Colors
            const sidebar = document.getElementById('sidebar-bg');
            const mobileBg = document.getElementById('mobile-logo-bg');
            if(sidebar) sidebar.className = `w-64 flex-shrink-0 hidden md:flex flex-col shadow-xl z-10 transition-colors duration-500 ${isPutri ? 'bg-pink-900' : 'bg-blue-900'} text-white`;
            if(mobileBg) mobileBg.className = `p-1.5 rounded text-white ${isPutri ? 'bg-pink-600' : 'bg-blue-600'}`;
        }

        // --- INIT APP ---
        DataAdapter.init();

        // --- NAVIGATION ---
        window.navigateTo = (tabName) => {
            state.activeTab = tabName;
            renderApp();
        };

        // --- RENDER LOGIC ---
        function renderApp() {
            if (!state.user && !state.isOffline) return; 
            updateNavUI();
            renderGenderToggle(); // Render toggle first
            
            const content = document.getElementById('content-area');
            content.innerHTML = '';
            
            switch(state.activeTab) {
                case 'dashboard': renderDashboard(content); break;
                case 'santri': renderSantriManager(content); break;
                case 'absensi': renderAttendanceInput(content); break;
                case 'laporan': renderReports(content); break;
                case 'profil': renderProfileSettings(content); break;
            }
            lucide.createIcons();
        }

        function updateNavUI() {
            const isPutri = state.genderFilter === 'P';
            const activeBg = isPutri ? 'bg-pink-800' : 'bg-blue-800';
            
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.tab === state.activeTab;
                el.className = `nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActive ? activeBg + ' text-white shadow-md' : 'text-white/70 hover:bg-white/10 hover:text-white'}`;
            });
            document.querySelectorAll('.mobile-nav-item').forEach(el => {
                const isActive = el.dataset.tab === state.activeTab;
                el.className = `mobile-nav-item flex flex-col items-center justify-center w-full py-1 ${isActive ? (isPutri ? 'text-pink-600' : 'text-blue-600') : 'text-gray-400'}`;
                const iconContainer = el.querySelector('.icon-container');
                iconContainer.className = `mb-1 icon-container ${isActive ? (isPutri ? 'bg-pink-100 p-1 rounded-full' : 'bg-blue-100 p-1 rounded-full') : ''}`;
            });
        }

        function updateGlobalUI() {
            const name = state.schoolProfile?.namaPondok || 'SIAP';
            const sub = state.schoolProfile?.namaPondok ? 'Sistem Informasi' : 'Sistem Absensi Pesantren';
            const nameEls = ['sidebar-title', 'mobile-title'];
            nameEls.forEach(id => { const el = document.getElementById(id); if(el) el.innerText = name; });
            const subEls = ['sidebar-subtitle'];
            subEls.forEach(id => { const el = document.getElementById(id); if(el) el.innerText = sub; });
            const footEl = document.getElementById('footer-school-name');
            if(footEl) footEl.innerText = state.schoolProfile?.namaPondok || 'Pondok Pesantren';
        }

        // --- GENDER HELPER ---
        function getGenderIcon(genderCode) {
            if (genderCode === 'P') {
                return `<div class="bg-pink-100 p-1.5 rounded-full text-pink-500" title="Putri"><i data-lucide="user" class="w-4 h-4"></i></div>`;
            } else {
                return `<div class="bg-blue-100 p-1.5 rounded-full text-blue-500" title="Putra"><i data-lucide="user" class="w-4 h-4"></i></div>`;
            }
        }

        // 1. DASHBOARD
        function renderDashboard(container) {
            const today = new Date().toISOString().split('T')[0];
            // Filter attendance records to count only selected gender
            const filteredSantri = state.santriList.filter(s => s.gender === state.genderFilter);
            const filteredIds = filteredSantri.map(s => s.id);
            
            const todaySessions = state.attendanceRecords.filter(r => r.date === today);
            
            let totalPresent = 0, totalEntries = 0;
            todaySessions.forEach(session => {
                // Only count status for currently selected gender
                Object.entries(session.data).forEach(([id, status]) => {
                    if (filteredIds.includes(id)) {
                        if (status === 'H') totalPresent++;
                        totalEntries++;
                    }
                });
            });
            const percentage = totalEntries > 0 ? Math.round((totalPresent / totalEntries) * 100) : 0;
            const isPutri = state.genderFilter === 'P';
            const themeColor = isPutri ? 'pink' : 'blue';

            const html = `
                <div class="space-y-6 fade-in">
                    <div class="${isPutri ? 'bg-pink-800' : 'bg-blue-800'} text-white p-6 rounded-2xl shadow-lg relative overflow-hidden transition-colors duration-500">
                        <div class="absolute right-0 top-0 opacity-10 transform translate-x-10 -translate-y-5">
                            <i data-lucide="moon" class="w-40 h-40"></i>
                        </div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold mb-1">Ahlan wa Sahlan, Ustadz.</h2>
                            <p class="text-white/80 text-sm md:text-base">
                                Dashboard ${isPutri ? 'Putri' : 'Putra'} - ${state.schoolProfile?.namaPondok || 'Sistem Informasi Pesantren'}.
                            </p>
                            ${state.isOffline ? '<div class="mt-3 bg-black/20 border border-white/10 p-2 rounded text-xs text-white/90 flex items-start gap-2"><i data-lucide="wifi-off" class="w-4 h-4 mt-0.5 flex-shrink-0"></i> <span>Mode Offline (Lokal)</span></div>' : '<div class="mt-3 bg-black/20 border border-white/10 p-2 rounded text-xs text-white/90 flex items-center gap-2"><i data-lucide="cloud" class="w-4 h-4"></i> <span>Data Cloud Online</span></div>'}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderStatCard(`Total Santri ${isPutri ? 'Putri' : 'Putra'}`, filteredSantri.length, 'users', isPutri ? 'bg-pink-50 text-pink-500' : 'bg-blue-50 text-blue-500')}
                        ${renderStatCard('Kegiatan Hari Ini', todaySessions.length, 'clock', 'bg-orange-50 text-orange-500')}
                        ${renderStatCard('Kehadiran Hari Ini', percentage + '%', 'check-circle', 'bg-emerald-50 text-emerald-500', 'Rata-rata kehadiran')}
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                            <i data-lucide="book-open" class="text-gray-600 w-5 h-5"></i>
                            Kegiatan Terakhir Dicatat
                        </h3>
                        ${state.attendanceRecords.length === 0 
                            ? '<p class="text-gray-400 italic text-sm">Belum ada data absensi.</p>' 
                            : `<div class="space-y-3">
                                ${state.attendanceRecords.slice(-5).reverse().map(record => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                        <div class="flex items-center gap-3">
                                            <div class="${isPutri ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700'} p-2 rounded-full">
                                                <i data-lucide="calendar-check" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-800 capitalize">${record.activity}</p>
                                                <p class="text-xs text-gray-500">${new Date(record.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                               </div>`
                        }
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderStatCard(title, value, icon, colorClass, desc = '') {
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-start justify-between">
                <div><p class="text-sm font-medium text-gray-500 mb-1">${title}</p><h3 class="text-3xl font-bold text-gray-800">${value}</h3>${desc ? `<p class="text-xs text-gray-400 mt-1">${desc}</p>` : ''}</div>
                <div class="p-3 rounded-lg ${colorClass}"><i data-lucide="${icon}" class="w-6 h-6"></i></div>
            </div>`;
        }

        // 2. SANTRI MANAGER
        function renderSantriManager(container) {
            const isPutri = state.genderFilter === 'P';
            const themeBtn = isPutri ? 'bg-pink-600 hover:bg-pink-700' : 'bg-blue-600 hover:bg-blue-700';
            
            // Filter list based on toggle
            const displayList = state.santriList.filter(s => s.gender === state.genderFilter);

            window.toggleAddSantri = () => {
                const form = document.getElementById('add-santri-form');
                form.classList.toggle('hidden');
                document.getElementById('add-btn-text').innerText = form.classList.contains('hidden') ? 'Tambah Santri' : 'Batal';
                lucide.createIcons();
            };

            window.submitSantri = async (e) => {
                e.preventDefault();
                const nama = document.getElementById('s-nama').value;
                const kelas = document.getElementById('s-kelas').value;
                const kamar = document.getElementById('s-kamar').value;
                // Gender defaults to current filter for convenience, or user selection
                const gender = document.getElementById('s-gender').value;
                
                try {
                    await DataAdapter.saveSantri({ nama, kelas, kamar, gender });
                    document.getElementById('santri-form-el').reset();
                    // Reset selector to current filter
                    document.getElementById('s-gender').value = state.genderFilter;
                    toggleAddSantri();
                } catch (err) { alert("Gagal menambah santri"); }
            };

            window.deleteSantri = async (id) => {
                if(confirm("Hapus data santri ini?")) {
                    try { await DataAdapter.deleteSantri(id); } catch(err) { alert("Gagal menghapus"); }
                }
            };

            const html = `
                <div class="space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Data Santri ${isPutri ? 'Putri' : 'Putra'}</h2>
                            <p class="text-gray-500">Kelola daftar santri aktif.</p>
                        </div>
                        <button onclick="toggleAddSantri()" class="${themeBtn} text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-sm w-full md:w-auto justify-center">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            <span id="add-btn-text">Tambah Santri</span>
                        </button>
                    </div>
                    
                    <div id="add-santri-form" class="hidden bg-white p-6 rounded-xl shadow-md border border-gray-100">
                        <h3 class="font-semibold mb-4 text-gray-800">Form Santri Baru</h3>
                        <form id="santri-form-el" onsubmit="submitSantri(event)">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                                    <input type="text" id="s-nama" required placeholder="Contoh: Ahmad Fulan" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                                    <select id="s-gender" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                        <option value="L" ${!isPutri ? 'selected' : ''}>Laki-laki (Putra)</option>
                                        <option value="P" ${isPutri ? 'selected' : ''}>Perempuan (Putri)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                    <input type="text" id="s-kelas" placeholder="Contoh: 1 Wustho" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kamar</label>
                                    <input type="text" id="s-kamar" placeholder="Abu Bakar 01" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="${themeBtn} text-white px-6 py-2 rounded-lg font-medium">Simpan Data</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Nama / JK</th>
                                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Kamar</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${displayList.length === 0 
                                        ? `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">Belum ada data santri ${isPutri ? 'Putri' : 'Putra'}.</td></tr>` 
                                        : displayList.map(s => `
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    ${getGenderIcon(s.gender)}
                                                    <span class="font-medium text-gray-900">${s.nama}</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-gray-600">${s.kelas || '-'}</td>
                                            <td class="px-6 py-4 text-gray-600">${s.kamar || '-'}</td>
                                            <td class="px-6 py-4 text-right">
                                                <button onclick="deleteSantri('${s.id}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            container.innerHTML = html;
        }

        // 3. ATTENDANCE INPUT
        function renderAttendanceInput(container) {
            const currentSessionId = `${state.absensiForm.date}_${state.absensiForm.activity.replace(/\s+/g, '_')}`;
            const isPutri = state.genderFilter === 'P';
            const themeColor = isPutri ? 'pink' : 'blue';
            const themeBorder = isPutri ? 'border-pink-200' : 'border-blue-200';
            const themeBg = isPutri ? 'bg-pink-50' : 'bg-blue-50';
            const themeText = isPutri ? 'text-pink-800' : 'text-blue-800';
            const themeBtn = isPutri ? 'bg-pink-600 hover:bg-pink-700' : 'bg-blue-600 hover:bg-blue-700';

            // Filter students
            const displayList = state.santriList.filter(s => s.gender === state.genderFilter);

            if (state.absensiForm.loadedId !== currentSessionId) {
                const existing = state.attendanceRecords.find(r => r.id === currentSessionId);
                let currentData = {};
                
                if (existing) {
                    currentData = { ...existing.data };
                    // Check logic for new students only for valid list
                    state.santriList.forEach(s => {
                        if (currentData[s.id] === undefined) {
                            currentData[s.id] = 'H';
                        }
                    });
                    state.absensiForm.isSaved = true; 
                } else {
                    state.santriList.forEach(s => currentData[s.id] = 'H');
                    state.absensiForm.isSaved = false;
                }
                
                state.absensiForm.data = currentData;
                state.absensiForm.loadedId = currentSessionId;
            }

            window.updateAbsenField = (field, value) => {
                state.absensiForm[field] = value;
                renderAttendanceInput(container);
            };

            window.setStatus = (id, status) => {
                state.absensiForm.data[id] = status;
                state.absensiForm.isSaved = false; 
                renderAttendanceInput(container); 
            };

            window.saveAbsensi = async () => {
                if (state.santriList.length === 0) return;
                const id = currentSessionId;
                try {
                    await DataAdapter.saveAbsensi(id, {
                        date: state.absensiForm.date,
                        activity: state.absensiForm.activity,
                        data: state.absensiForm.data
                    });
                    state.absensiForm.isSaved = true;
                    // Update cache
                    const existingIdx = state.attendanceRecords.findIndex(r => r.id === id);
                    const newRecord = { id, date: state.absensiForm.date, activity: state.absensiForm.activity, data: state.absensiForm.data };
                    if (existingIdx >= 0) state.attendanceRecords[existingIdx] = newRecord;
                    else state.attendanceRecords.push(newRecord);

                    renderAttendanceInput(container); // Re-render to show success state
                } catch (e) { alert("Gagal menyimpan: " + e.message); }
            };

            const getBtnClass = (santriId, val, currentVal, baseColor) => {
                const isSelected = currentVal === val;
                const colors = {
                    emerald: isSelected ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-emerald-100 text-emerald-700 border-emerald-200',
                    yellow: isSelected ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-yellow-100 text-yellow-700 border-yellow-200',
                    blue: isSelected ? 'bg-blue-500 text-white border-blue-500' : 'bg-blue-100 text-blue-700 border-blue-200',
                    red: isSelected ? 'bg-red-500 text-white border-red-500' : 'bg-red-100 text-red-700 border-red-200'
                };
                return `w-10 h-10 md:w-auto md:h-auto md:px-3 md:py-1.5 rounded-full md:rounded-lg border text-sm font-medium transition-all duration-200 flex items-center justify-center ${colors[baseColor]} ${isSelected ? 'opacity-100 scale-105 shadow-sm' : 'hover:opacity-80 opacity-60'}`;
            };

            const html = `
                <div class="space-y-6 fade-in">
                     <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex flex-col md:flex-row gap-4 w-full">
                           <div class="flex-1">
                               <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal</label>
                               <input type="date" value="${state.absensiForm.date}" onchange="updateAbsenField('date', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                           </div>
                           <div class="flex-1">
                               <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kegiatan</label>
                               <select onchange="updateAbsenField('activity', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">${activities.map(a => `<option value="${a}" ${state.absensiForm.activity === a ? 'selected' : ''}>${a}</option>`).join('')}</select>
                           </div>
                        </div>
                     </div>
                     <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 ${themeBg} border-b ${themeBorder} flex justify-between items-center">
                            <h3 class="font-semibold ${themeText} flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4"></i> Absensi ${isPutri ? 'Putri' : 'Putra'}
                            </h3>
                            <div class="text-xs font-medium bg-white/50 px-3 py-1 rounded-full border ${themeBorder}">Total: ${displayList.length}</div>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto">
                           <table class="w-full text-sm text-left">
                              <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm border-b border-gray-200">
                                <tr>
                                  <th class="px-4 py-3 w-12 text-center text-xs font-bold uppercase tracking-wider">No</th>
                                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Data Santri</th>
                                  <th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Status Kehadiran</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-gray-100">
                                ${displayList.length === 0 ? `<tr><td colspan="3" class="p-8 text-center text-gray-500 italic">Belum ada data santri ${isPutri ? 'Putri' : 'Putra'}.</td></tr>` : 
                                displayList.map((s, index) => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-4 py-3 text-center text-gray-500 font-medium border-r border-transparent">${index + 1}</td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-3">
                                                ${getGenderIcon(s.gender)}
                                                <div>
                                                    <div class="font-semibold text-gray-900">${s.nama}</div>
                                                    <div class="text-xs text-gray-500 flex items-center gap-2 mt-0.5">
                                                        <span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 border border-gray-200">${s.kelas || '-'}</span>
                                                        <span class="text-gray-400"></span>
                                                        <span>${s.kamar || '-'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center justify-center gap-2">
                                                <button onclick="setStatus('${s.id}', 'H')" class="${getBtnClass(s.id, 'H', state.absensiForm.data[s.id], 'emerald')} shadow-sm" title="Hadir"><span class="font-bold">H</span></button>
                                                <button onclick="setStatus('${s.id}', 'S')" class="${getBtnClass(s.id, 'S', state.absensiForm.data[s.id], 'yellow')} shadow-sm" title="Sakit"><span class="font-bold">S</span></button>
                                                <button onclick="setStatus('${s.id}', 'I')" class="${getBtnClass(s.id, 'I', state.absensiForm.data[s.id], 'blue')} shadow-sm" title="Izin"><span class="font-bold">I</span></button>
                                                <button onclick="setStatus('${s.id}', 'A')" class="${getBtnClass(s.id, 'A', state.absensiForm.data[s.id], 'red')} shadow-sm" title="Alpha"><span class="font-bold">A</span></button>
                                            </div>
                                        </td>
                                    </tr>`).join('')}
                              </tbody>
                           </table>
                        </div>
                        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                            <button id="save-absen-btn" onclick="saveAbsensi()" class="${state.absensiForm.isSaved ? 'bg-emerald-100 text-emerald-700 cursor-default border border-emerald-200' : themeBtn + ' text-white shadow-lg hover:shadow-xl transform hover:-translate-y-0.5'} flex items-center gap-2 px-6 py-2.5 rounded-lg font-bold transition-all duration-200">
                                <i data-lucide="${state.absensiForm.isSaved ? 'check-circle' : 'save'}" class="w-5 h-5"></i> 
                                ${state.absensiForm.isSaved ? 'Absensi Tersimpan' : 'Simpan Absensi'}
                            </button>
                        </div>
                     </div>
                </div>`;
            container.innerHTML = html;
        }

        // 4. REPORTS
        function renderReports(container) {
            window.setReportDate = (val) => { state.laporanDate = val; renderReports(container); };
            const records = state.attendanceRecords.filter(r => r.date === state.laporanDate);
            
            // Filter counts based on active gender
            const activeSantri = state.santriList.filter(s => s.gender === state.genderFilter);
            const activeIds = activeSantri.map(s => s.id);

            let s = 0, i = 0, a = 0, h = 0;
            records.forEach(r => { 
                Object.entries(r.data).forEach(([id, st]) => { 
                    if(activeIds.includes(id)) {
                        if(st==='S')s++;else if(st==='I')i++;else if(st==='A')a++;else h++; 
                    }
                }); 
            });

            const html = `
                <div class="space-y-6 fade-in">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Laporan Harian (${state.genderFilter === 'L' ? 'Putra' : 'Putri'})</h2>
                         <div class="w-full md:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Tanggal</label><input type="date" value="${state.laporanDate}" onchange="setReportDate(this.value)" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 rounded-xl flex flex-col items-center justify-center bg-emerald-100 text-emerald-800"><span class="text-2xl font-bold">${h}</span><span class="text-xs font-semibold uppercase opacity-80">Hadir</span></div>
                        <div class="p-4 rounded-xl flex flex-col items-center justify-center bg-yellow-100 text-yellow-800"><span class="text-2xl font-bold">${s}</span><span class="text-xs font-semibold uppercase opacity-80">Sakit</span></div>
                        <div class="p-4 rounded-xl flex flex-col items-center justify-center bg-blue-100 text-blue-800"><span class="text-2xl font-bold">${i}</span><span class="text-xs font-semibold uppercase opacity-80">Izin</span></div>
                        <div class="p-4 rounded-xl flex flex-col items-center justify-center bg-red-100 text-red-800"><span class="text-2xl font-bold">${a}</span><span class="text-xs font-semibold uppercase opacity-80">Alpha</span></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b border-gray-200"><h3 class="font-semibold text-gray-700">Detail Kegiatan per Sesi</h3></div>
                        ${records.length === 0 ? '<div class="p-8 text-center text-gray-500 italic">Tidak ada data absensi untuk tanggal ini.</div>' : `
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="px-4 py-3 font-semibold text-gray-600">Kegiatan</th><th class="px-4 py-3 font-semibold text-gray-600">Total</th><th class="px-4 py-3 font-semibold text-emerald-600">Hadir</th><th class="px-4 py-3 font-semibold text-red-600">Tidak Hadir</th><th class="px-4 py-3 font-semibold text-gray-600">Ketidakhadiran</th></tr></thead>
                        <tbody class="divide-y divide-gray-100">${records.map(r => {
                            // Calc stats per session restricted to gender
                            let sesH=0, sesTotal=0;
                            let absenteesHTML = [];
                            
                            Object.entries(r.data).forEach(([id, st]) => {
                                if(activeIds.includes(id)) {
                                    sesTotal++;
                                    if(st==='H') sesH++;
                                    else {
                                        const sa = activeSantri.find(s=>s.id===id);
                                        if(sa) absenteesHTML.push(`${getGenderIcon(sa.gender)} <span class="ml-1">${sa.nama} (${st})</span>`);
                                    }
                                }
                            });
                            
                            const sesAbsen = sesTotal - sesH;
                            const absenteeStr = absenteesHTML.map(h => `<div class="flex items-center gap-1 mb-1">${h}</div>`).join('') || '-';

                            return `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-medium">${r.activity}</td><td class="px-4 py-3">${sesTotal}</td><td class="px-4 py-3 text-emerald-600 font-bold">${sesH}</td><td class="px-4 py-3 text-red-600 font-bold">${sesAbsen}</td><td class="px-4 py-3 text-gray-500 text-xs">${absenteeStr}</td></tr>`;
                        }).join('')}</tbody></table></div>`}
                    </div>
                </div>`;
            container.innerHTML = html;
        }

        // 5. PROFILE (UNCHANGED, JUST RENDER)
        function renderProfileSettings(container) {
            window.updateProfileForm = (field, val) => { state.profileForm[field] = val; };
            // ... (keep existing functions: saveDriveConfig, loginDrive, etc.) ...
            window.saveDriveConfig = () => {
                const clientId = document.getElementById('gd-client-id').value;
                const apiKey = document.getElementById('gd-api-key').value;
                if(!clientId || !apiKey) return alert("Client ID dan API Key tidak boleh kosong!");
                state.gDrive.config = { clientId, apiKey };
                localStorage.setItem('gdrive_config', JSON.stringify(state.gDrive.config));
                alert("Konfigurasi Drive tersimpan!");
                GDriveAdapter.loadGapi();
            };
            window.loginDrive = () => { GDriveAdapter.login(); };
            window.backupToDrive = () => { GDriveAdapter.saveToDrive(); };
            window.restoreFromDrive = () => { GDriveAdapter.loadFromDrive(); };
            window.saveProfile = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-profile-btn');
                btn.innerText = 'Menyimpan...';
                try {
                    await DataAdapter.saveProfile(state.profileForm);
                    alert("Profil berhasil diperbarui!");
                } catch(err) { alert("Gagal menyimpan."); }
                btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Simpan Profil';
                lucide.createIcons();
            };

            const html = `
                <div class="max-w-2xl mx-auto space-y-6 fade-in pb-12">
                    <div><h2 class="text-2xl font-bold text-gray-800">Profil & Database</h2><p class="text-gray-500">Atur identitas lembaga dan koneksi server.</p></div>
                    <form onsubmit="saveProfile(event)" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nama Pondok</label><input type="text" value="${state.profileForm.namaPondok || ''}" onchange="updateProfileForm('namaPondok', this.value)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Pengasuh</label><input type="text" value="${state.profileForm.pengasuh || ''}" onchange="updateProfileForm('pengasuh', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Alamat</label><textarea rows="3" onchange="updateProfileForm('alamat', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">${state.profileForm.alamat || ''}</textarea></div>
                         <div><label class="block text-sm font-semibold text-gray-700 mb-1">Kontak</label><input type="text" value="${state.profileForm.kontak || ''}" onchange="updateProfileForm('kontak', this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                        <div class="pt-4"><button type="submit" id="save-profile-btn" class="w-full bg-emerald-600 text-white px-6 py-2.5 rounded-lg hover:bg-emerald-700 font-medium flex items-center justify-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Profil</button></div>
                    </form>
                    <!-- GOOGLE DRIVE SECTION -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100">
                        <div class="flex items-center gap-2 mb-2">
                             <div class="bg-blue-100 p-2 rounded-full"><i data-lucide="hard-drive" class="text-blue-600 w-5 h-5"></i></div>
                             <h3 class="text-lg font-bold text-gray-800">Google Drive Backup</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Simpan backup data ke Google Drive Anda (iyaanend2@gmail.com).</p>
                        <div class="hidden">
                            <input type="text" id="gd-client-id" value="${state.gDrive.config.clientId || ''}">
                            <input type="text" id="gd-api-key" value="${state.gDrive.config.apiKey || ''}">
                        </div>
                        <div class="flex flex-col md:flex-row gap-3 items-center border-t border-gray-100 pt-4">
                            ${state.gDrive.connected ? '' : `
                            <button onclick="loginDrive()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition w-full md:w-auto justify-center"><i data-lucide="log-in" class="w-4 h-4"></i> Login Google</button>`}
                            <span id="gd-status" class="text-xs text-gray-500">${state.gDrive.connected ? '<span class="text-green-600 font-bold">Terhubung ke Google</span>' : 'Belum Login'}</span>
                        </div>
                        ${state.gDrive.connected ? `
                        <div class="grid grid-cols-2 gap-4 mt-4 animate-in fade-in">
                            <button onclick="backupToDrive()" class="flex flex-col items-center justify-center p-3 border border-blue-200 bg-blue-50 rounded-lg hover:bg-blue-100 transition text-blue-800"><i data-lucide="upload-cloud" class="w-6 h-6 mb-1"></i><span class="text-xs font-bold">Backup ke Drive</span></button>
                            <button onclick="restoreFromDrive()" class="flex flex-col items-center justify-center p-3 border border-orange-200 bg-orange-50 rounded-lg hover:bg-orange-100 transition text-orange-800"><i data-lucide="download-cloud" class="w-6 h-6 mb-1"></i><span class="text-xs font-bold">Restore dari Drive</span></button>
                        </div>` : ''}
                    </div>
                </div>`;
            container.innerHTML = html;
        }
    </script>
<button id="btn-connect-drive" onclick="handleAuthClick()" style="display:block; margin: 20px auto; padding: 10px 20px; background-color: #4285F4; color: white; border: none; border-radius: 5px; cursor: pointer;">
    Sambungkan ke Google Drive
</button>

<script>
    // --- ISI KODE RAHASIA DISINI ---
    const CLIENT_ID = '133835424632-crnnjf5mhr3g2bl4fsqvh13hld6h92gc.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDySWvaM7P-P3-kmDGNnUCt2TmZQ1XKg8AI';
    // -------------------------------

    // Konfigurasi (Jangan Diubah)
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // Fungsi saat Script Google Selesai Dimuat
    function gapiLoaded() {
        gapi.load('client', intializeGapiClient);
    }

    async function intializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // Didefinisikan nanti saat klik tombol
        });
        gisInited = true;
    }

    // Fungsi Saat Tombol Ditekan
    function handleAuthClick() {
        if (!gapiInited || !gisInited) {
            alert("Sabar, Google sedang loading...");
            return;
        }

        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            // BERHASIL LOGIN!
            alert("HORE! Berhasil tersambung ke Google Drive milikmu!");
            document.getElementById("btn-connect-drive").innerText = "Sudah Terhubung ";
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }
</script>
 <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>